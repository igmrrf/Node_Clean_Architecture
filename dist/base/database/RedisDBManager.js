"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true,
});
var tslib_1 = require("tslib");
var redis_1 = tslib_1.__importDefault(require("redis"));
var RedisDBManager = /** @class */ (function () {
  function RedisDBManager(_a) {
    var config = _a.config,
      logger = _a.logger;
    var _this = this;
    this.config = config;
    this.logger = logger;
    var redisUrl = config.get("app.redisUrl");
    this.client = redis_1.default.createClient({
      url: redisUrl,
    });
    this.client.on("error", function () {
      return _this.logger.error("Error while connecting to Redis");
    });
  }
  RedisDBManager.prototype.connect = function (numOfRetries) {
    if (numOfRetries === void 0) {
      numOfRetries = 3;
    }
    return tslib_1.__awaiter(this, void 0, void 0, function () {
      var error_1;
      var _this = this;
      return tslib_1.__generator(this, function (_a) {
        switch (_a.label) {
          case 0:
            _a.trys.push([0, 2, , 3]);
            return [4 /*yield*/, this.client.connect()];
          case 1:
            _a.sent();
            return [3 /*break*/, 3];
          case 2:
            error_1 = _a.sent();
            this.logger.error("Failed to connect to Redis", error_1);
            if (numOfRetries <= 0) {
              this.logger.error("Exhausted max number of retires for connecting Redis");
              process.exit(1);
            }
            setTimeout(function () {
              _this.connect(numOfRetries - 1);
            }, 1000);
            return [3 /*break*/, 3];
          case 3:
            return [2 /*return*/];
        }
      });
    });
  };

  RedisDBManager.prototype.disconnect = function () {
    return tslib_1.__awaiter(this, void 0, void 0, function () {
      var error_2;
      return tslib_1.__generator(this, function (_a) {
        switch (_a.label) {
          case 0:
            this.logger.info("Disconnecting database connection...");
            _a.label = 1;
          case 1:
            _a.trys.push([1, 3, , 4]);
            return [4 /*yield*/, this.client.quit()];
          case 2:
            _a.sent();
            return [3 /*break*/, 4];
          case 3:
            error_2 = _a.sent();
            this.logger.error("Error while disconnecting Redis Database", {
              error: error_2,
            });
            process.exit(1);
            return [3 /*break*/, 4];
          case 4:
            return [2 /*return*/];
        }
      });
    });
  };

  return RedisDBManager;
})();
exports.default = RedisDBManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsInRzbGliXzEiLCJyZXF1aXJlIiwicmVkaXNfMSIsIl9faW1wb3J0RGVmYXVsdCIsIlJlZGlzREJNYW5hZ2VyIiwiX2EiLCJjb25maWciLCJsb2dnZXIiLCJfdGhpcyIsInJlZGlzVXJsIiwiZ2V0IiwiY2xpZW50IiwiZGVmYXVsdCIsImNyZWF0ZUNsaWVudCIsInVybCIsIm9uIiwiZXJyb3IiLCJwcm90b3R5cGUiLCJjb25uZWN0IiwibnVtT2ZSZXRyaWVzIiwiX19hd2FpdGVyIiwiZXJyb3JfMSIsIl9fZ2VuZXJhdG9yIiwibGFiZWwiLCJ0cnlzIiwicHVzaCIsInNlbnQiLCJwcm9jZXNzIiwiZXhpdCIsInNldFRpbWVvdXQiLCJkaXNjb25uZWN0IiwiZXJyb3JfMiIsImluZm8iLCJxdWl0Il0sInNvdXJjZXMiOlsiLi4vLi4vLi4vdHlwZWQvYmFzZS9kYXRhYmFzZS9SZWRpc0RCTWFuYWdlci5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbnZhciB0c2xpYl8xID0gcmVxdWlyZShcInRzbGliXCIpO1xudmFyIHJlZGlzXzEgPSB0c2xpYl8xLl9faW1wb3J0RGVmYXVsdChyZXF1aXJlKFwicmVkaXNcIikpO1xudmFyIFJlZGlzREJNYW5hZ2VyID0gLyoqIEBjbGFzcyAqLyAoZnVuY3Rpb24gKCkge1xuICAgIGZ1bmN0aW9uIFJlZGlzREJNYW5hZ2VyKF9hKSB7XG4gICAgICAgIHZhciBjb25maWcgPSBfYS5jb25maWcsIGxvZ2dlciA9IF9hLmxvZ2dlcjtcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuICAgICAgICB2YXIgcmVkaXNVcmwgPSBjb25maWcuZ2V0KFwiYXBwLnJlZGlzVXJsXCIpO1xuICAgICAgICB0aGlzLmNsaWVudCA9IHJlZGlzXzEuZGVmYXVsdC5jcmVhdGVDbGllbnQoeyB1cmw6IHJlZGlzVXJsIH0pO1xuICAgICAgICB0aGlzLmNsaWVudC5vbihcImVycm9yXCIsIGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmxvZ2dlci5lcnJvcihcIkVycm9yIHdoaWxlIGNvbm5lY3RpbmcgdG8gUmVkaXNcIik7IH0pO1xuICAgIH1cbiAgICBSZWRpc0RCTWFuYWdlci5wcm90b3R5cGUuY29ubmVjdCA9IGZ1bmN0aW9uIChudW1PZlJldHJpZXMpIHtcbiAgICAgICAgaWYgKG51bU9mUmV0cmllcyA9PT0gdm9pZCAwKSB7IG51bU9mUmV0cmllcyA9IDM7IH1cbiAgICAgICAgcmV0dXJuIHRzbGliXzEuX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgZXJyb3JfMTtcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgICAgICByZXR1cm4gdHNsaWJfMS5fX2dlbmVyYXRvcih0aGlzLCBmdW5jdGlvbiAoX2EpIHtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKF9hLmxhYmVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMDpcbiAgICAgICAgICAgICAgICAgICAgICAgIF9hLnRyeXMucHVzaChbMCwgMiwgLCAzXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCB0aGlzLmNsaWVudC5jb25uZWN0KCldO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDE6XG4gICAgICAgICAgICAgICAgICAgICAgICBfYS5zZW50KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gWzMgLypicmVhayovLCAzXTtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAyOlxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JfMSA9IF9hLnNlbnQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFwiRmFpbGVkIHRvIGNvbm5lY3QgdG8gUmVkaXNcIiwgZXJyb3JfMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobnVtT2ZSZXRyaWVzIDw9IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcIkV4aGF1c3RlZCBtYXggbnVtYmVyIG9mIHJldGlyZXMgZm9yIGNvbm5lY3RpbmcgUmVkaXNcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuY29ubmVjdChudW1PZlJldHJpZXMgLSAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDEwMDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFszIC8qYnJlYWsqLywgM107XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMzogcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9O1xuICAgIFJlZGlzREJNYW5hZ2VyLnByb3RvdHlwZS5kaXNjb25uZWN0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gdHNsaWJfMS5fX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBlcnJvcl8yO1xuICAgICAgICAgICAgcmV0dXJuIHRzbGliXzEuX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9hKSB7XG4gICAgICAgICAgICAgICAgc3dpdGNoIChfYS5sYWJlbCkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDA6XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKFwiRGlzY29ubmVjdGluZyBkYXRhYmFzZSBjb25uZWN0aW9uLi4uXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgX2EubGFiZWwgPSAxO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDE6XG4gICAgICAgICAgICAgICAgICAgICAgICBfYS50cnlzLnB1c2goWzEsIDMsICwgNF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgdGhpcy5jbGllbnQucXVpdCgpXTtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAyOlxuICAgICAgICAgICAgICAgICAgICAgICAgX2Euc2VudCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFszIC8qYnJlYWsqLywgNF07XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMzpcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yXzIgPSBfYS5zZW50KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcIkVycm9yIHdoaWxlIGRpc2Nvbm5lY3RpbmcgUmVkaXMgRGF0YWJhc2VcIiwgeyBlcnJvcjogZXJyb3JfMiB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbMyAvKmJyZWFrKi8sIDRdO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDQ6IHJldHVybiBbMiAvKnJldHVybiovXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfTtcbiAgICByZXR1cm4gUmVkaXNEQk1hbmFnZXI7XG59KCkpO1xuZXhwb3J0cy5kZWZhdWx0ID0gUmVkaXNEQk1hbmFnZXI7XG4iXSwibWFwcGluZ3MiOiJBQUFBLFlBQVk7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
