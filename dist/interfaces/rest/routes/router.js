"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true,
});
var tslib_1 = require("tslib");
// import CacheMan from "cacheman";
// import EngineRedis from "cacheman-redis";
var errorHandler_1 = tslib_1.__importDefault(require("../middlewares/errorHandler"));
var notFoundHandler_1 = tslib_1.__importDefault(require("../middlewares/notFoundHandler"));
var cors_1 = tslib_1.__importDefault(require("cors"));
var express_1 = tslib_1.__importStar(require("express"));
var morgan_1 = tslib_1.__importDefault(require("morgan"));
var v1_1 = tslib_1.__importDefault(require("./v1"));
/**
 * Configures express middlewares
 */
exports.default = function (_a) {
  var config = _a.config,
    containerMiddleware = _a.containerMiddleware;
  var router = (0, express_1.Router)();
  router.use(require("helmet")());
  var NODE_ENV = config.get("app.env");
  router.use((0, morgan_1.default)(NODE_ENV === "production" ? "combined" : "dev"));
  var bodyLimit = config.get("app.bodyLimit");
  // const appName = config.get("app.serviceName");
  // const cacheExpiry = config.get("app.cacheExpiry");
  // const caching = async (req, res, next) => {
  //   // Set up Cache Engine
  //   const cache = new EngineRedis();
  //   const apiCache = new CacheMan(appName, { engine: cache, ttl: cacheExpiry });
  //   req.cache = apiCache;
  //   res.set({ "Cache-Control": `private, max-age=${cacheExpiry}` });
  //   // Create Cache Key
  //   const key = [];
  //   key.push(req.url);
  //   key.push(req.ip);
  //   key.push(req.cookies);
  //   key.push(req.get("Content-Type"));
  //   req.cacheKey = key;
  //   if (req.method === "GET" && req.cacheKey) {
  //     const cacheResponse = await req.cache.get(req.cacheKey);
  //     if (cacheResponse) {
  //       return res.ok(cacheResponse, true);
  //     }
  //   }
  //   return next();
  // };
  router.use(
    express_1.default.urlencoded({
      extended: false,
      limit: bodyLimit,
    }),
  );
  router.use(
    express_1.default.json({
      limit: bodyLimit,
    }),
  );
  router.use(
    express_1.default.raw({
      limit: bodyLimit,
    }),
  );
  router.use(
    express_1.default.text({
      limit: bodyLimit,
    }),
  );
  // Setup CORS
  var allowedOrigins = config.get("app.allowedOrigins");
  router.use(
    (0, cors_1.default)({
      origin: function (origin, cb) {
        if (allowedOrigins.trim() === "*") {
          cb(null, true);
        } else {
          var origins = allowedOrigins.split(",");
          if (origins.indexOf(origin) !== -1 || !origin) {
            cb(null, true);
          } else {
            cb(new Error("Origin('".concat(origin, "') not allowed")), false);
          }
        }
      },
      optionsSuccessStatus: 200, // some legacy browsers (IE11, various SmartTVs) choke on 204
    }),
  );
  // Setup Caching
  // router.use(caching());
  // https://www.npmjs.com/package/awilix-express
  router.use(containerMiddleware);
  router.get("/", function (req, res) {
    return res.json({
      message: "Node_Clean",
    });
  });
  router.use("/v1", v1_1.default);
  router.use(notFoundHandler_1.default);
  router.use(errorHandler_1.default);
  return router;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsInRzbGliXzEiLCJyZXF1aXJlIiwiZXJyb3JIYW5kbGVyXzEiLCJfX2ltcG9ydERlZmF1bHQiLCJub3RGb3VuZEhhbmRsZXJfMSIsImNvcnNfMSIsImV4cHJlc3NfMSIsIl9faW1wb3J0U3RhciIsIm1vcmdhbl8xIiwidjFfMSIsImRlZmF1bHQiLCJfYSIsImNvbmZpZyIsImNvbnRhaW5lck1pZGRsZXdhcmUiLCJyb3V0ZXIiLCJSb3V0ZXIiLCJ1c2UiLCJOT0RFX0VOViIsImdldCIsImJvZHlMaW1pdCIsInVybGVuY29kZWQiLCJleHRlbmRlZCIsImxpbWl0IiwianNvbiIsInJhdyIsInRleHQiLCJhbGxvd2VkT3JpZ2lucyIsIm9yaWdpbiIsImNiIiwidHJpbSIsIm9yaWdpbnMiLCJzcGxpdCIsImluZGV4T2YiLCJFcnJvciIsImNvbmNhdCIsIm9wdGlvbnNTdWNjZXNzU3RhdHVzIiwicmVxIiwicmVzIiwibWVzc2FnZSJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3R5cGVkL2ludGVyZmFjZXMvcmVzdC9yb3V0ZXMvcm91dGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xudmFyIHRzbGliXzEgPSByZXF1aXJlKFwidHNsaWJcIik7XG4vLyBpbXBvcnQgQ2FjaGVNYW4gZnJvbSBcImNhY2hlbWFuXCI7XG4vLyBpbXBvcnQgRW5naW5lUmVkaXMgZnJvbSBcImNhY2hlbWFuLXJlZGlzXCI7XG52YXIgZXJyb3JIYW5kbGVyXzEgPSB0c2xpYl8xLl9faW1wb3J0RGVmYXVsdChyZXF1aXJlKFwiaW50ZXJmYWNlcy9yZXN0L21pZGRsZXdhcmVzL2Vycm9ySGFuZGxlclwiKSk7XG52YXIgbm90Rm91bmRIYW5kbGVyXzEgPSB0c2xpYl8xLl9faW1wb3J0RGVmYXVsdChyZXF1aXJlKFwiaW50ZXJmYWNlcy9yZXN0L21pZGRsZXdhcmVzL25vdEZvdW5kSGFuZGxlclwiKSk7XG52YXIgY29yc18xID0gdHNsaWJfMS5fX2ltcG9ydERlZmF1bHQocmVxdWlyZShcImNvcnNcIikpO1xudmFyIGV4cHJlc3NfMSA9IHRzbGliXzEuX19pbXBvcnRTdGFyKHJlcXVpcmUoXCJleHByZXNzXCIpKTtcbnZhciBtb3JnYW5fMSA9IHRzbGliXzEuX19pbXBvcnREZWZhdWx0KHJlcXVpcmUoXCJtb3JnYW5cIikpO1xudmFyIHYxXzEgPSB0c2xpYl8xLl9faW1wb3J0RGVmYXVsdChyZXF1aXJlKFwiLi92MVwiKSk7XG4vKipcbiAqIENvbmZpZ3VyZXMgZXhwcmVzcyBtaWRkbGV3YXJlc1xuICovXG5leHBvcnRzLmRlZmF1bHQgPSAoZnVuY3Rpb24gKF9hKSB7XG4gICAgdmFyIGNvbmZpZyA9IF9hLmNvbmZpZywgY29udGFpbmVyTWlkZGxld2FyZSA9IF9hLmNvbnRhaW5lck1pZGRsZXdhcmU7XG4gICAgdmFyIHJvdXRlciA9ICgwLCBleHByZXNzXzEuUm91dGVyKSgpO1xuICAgIHJvdXRlci51c2UocmVxdWlyZShcImhlbG1ldFwiKSgpKTtcbiAgICB2YXIgTk9ERV9FTlYgPSBjb25maWcuZ2V0KFwiYXBwLmVudlwiKTtcbiAgICByb3V0ZXIudXNlKCgwLCBtb3JnYW5fMS5kZWZhdWx0KShOT0RFX0VOViA9PT0gXCJwcm9kdWN0aW9uXCIgPyBcImNvbWJpbmVkXCIgOiBcImRldlwiKSk7XG4gICAgdmFyIGJvZHlMaW1pdCA9IGNvbmZpZy5nZXQoXCJhcHAuYm9keUxpbWl0XCIpO1xuICAgIC8vIGNvbnN0IGFwcE5hbWUgPSBjb25maWcuZ2V0KFwiYXBwLnNlcnZpY2VOYW1lXCIpO1xuICAgIC8vIGNvbnN0IGNhY2hlRXhwaXJ5ID0gY29uZmlnLmdldChcImFwcC5jYWNoZUV4cGlyeVwiKTtcbiAgICAvLyBjb25zdCBjYWNoaW5nID0gYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgLy8gICAvLyBTZXQgdXAgQ2FjaGUgRW5naW5lXG4gICAgLy8gICBjb25zdCBjYWNoZSA9IG5ldyBFbmdpbmVSZWRpcygpO1xuICAgIC8vICAgY29uc3QgYXBpQ2FjaGUgPSBuZXcgQ2FjaGVNYW4oYXBwTmFtZSwgeyBlbmdpbmU6IGNhY2hlLCB0dGw6IGNhY2hlRXhwaXJ5IH0pO1xuICAgIC8vICAgcmVxLmNhY2hlID0gYXBpQ2FjaGU7XG4gICAgLy8gICByZXMuc2V0KHsgXCJDYWNoZS1Db250cm9sXCI6IGBwcml2YXRlLCBtYXgtYWdlPSR7Y2FjaGVFeHBpcnl9YCB9KTtcbiAgICAvLyAgIC8vIENyZWF0ZSBDYWNoZSBLZXlcbiAgICAvLyAgIGNvbnN0IGtleSA9IFtdO1xuICAgIC8vICAga2V5LnB1c2gocmVxLnVybCk7XG4gICAgLy8gICBrZXkucHVzaChyZXEuaXApO1xuICAgIC8vICAga2V5LnB1c2gocmVxLmNvb2tpZXMpO1xuICAgIC8vICAga2V5LnB1c2gocmVxLmdldChcIkNvbnRlbnQtVHlwZVwiKSk7XG4gICAgLy8gICByZXEuY2FjaGVLZXkgPSBrZXk7XG4gICAgLy8gICBpZiAocmVxLm1ldGhvZCA9PT0gXCJHRVRcIiAmJiByZXEuY2FjaGVLZXkpIHtcbiAgICAvLyAgICAgY29uc3QgY2FjaGVSZXNwb25zZSA9IGF3YWl0IHJlcS5jYWNoZS5nZXQocmVxLmNhY2hlS2V5KTtcbiAgICAvLyAgICAgaWYgKGNhY2hlUmVzcG9uc2UpIHtcbiAgICAvLyAgICAgICByZXR1cm4gcmVzLm9rKGNhY2hlUmVzcG9uc2UsIHRydWUpO1xuICAgIC8vICAgICB9XG4gICAgLy8gICB9XG4gICAgLy8gICByZXR1cm4gbmV4dCgpO1xuICAgIC8vIH07XG4gICAgcm91dGVyLnVzZShleHByZXNzXzEuZGVmYXVsdC51cmxlbmNvZGVkKHsgZXh0ZW5kZWQ6IGZhbHNlLCBsaW1pdDogYm9keUxpbWl0IH0pKTtcbiAgICByb3V0ZXIudXNlKGV4cHJlc3NfMS5kZWZhdWx0Lmpzb24oeyBsaW1pdDogYm9keUxpbWl0IH0pKTtcbiAgICByb3V0ZXIudXNlKGV4cHJlc3NfMS5kZWZhdWx0LnJhdyh7IGxpbWl0OiBib2R5TGltaXQgfSkpO1xuICAgIHJvdXRlci51c2UoZXhwcmVzc18xLmRlZmF1bHQudGV4dCh7IGxpbWl0OiBib2R5TGltaXQgfSkpO1xuICAgIC8vIFNldHVwIENPUlNcbiAgICB2YXIgYWxsb3dlZE9yaWdpbnMgPSBjb25maWcuZ2V0KFwiYXBwLmFsbG93ZWRPcmlnaW5zXCIpO1xuICAgIHJvdXRlci51c2UoKDAsIGNvcnNfMS5kZWZhdWx0KSh7XG4gICAgICAgIG9yaWdpbjogZnVuY3Rpb24gKG9yaWdpbiwgY2IpIHtcbiAgICAgICAgICAgIGlmIChhbGxvd2VkT3JpZ2lucy50cmltKCkgPT09IFwiKlwiKSB7XG4gICAgICAgICAgICAgICAgY2IobnVsbCwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgb3JpZ2lucyA9IGFsbG93ZWRPcmlnaW5zLnNwbGl0KFwiLFwiKTtcbiAgICAgICAgICAgICAgICBpZiAob3JpZ2lucy5pbmRleE9mKG9yaWdpbikgIT09IC0xIHx8ICFvcmlnaW4pIHtcbiAgICAgICAgICAgICAgICAgICAgY2IobnVsbCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjYihuZXcgRXJyb3IoXCJPcmlnaW4oJ1wiLmNvbmNhdChvcmlnaW4sIFwiJykgbm90IGFsbG93ZWRcIikpLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBvcHRpb25zU3VjY2Vzc1N0YXR1czogMjAwLCAvLyBzb21lIGxlZ2FjeSBicm93c2VycyAoSUUxMSwgdmFyaW91cyBTbWFydFRWcykgY2hva2Ugb24gMjA0XG4gICAgfSkpO1xuICAgIC8vIFNldHVwIENhY2hpbmdcbiAgICAvLyByb3V0ZXIudXNlKGNhY2hpbmcoKSk7XG4gICAgLy8gaHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvYXdpbGl4LWV4cHJlc3NcbiAgICByb3V0ZXIudXNlKGNvbnRhaW5lck1pZGRsZXdhcmUpO1xuICAgIHJvdXRlci5nZXQoXCIvXCIsIGZ1bmN0aW9uIChyZXEsIHJlcykgeyByZXR1cm4gcmVzLmpzb24oeyBtZXNzYWdlOiBcIk5vZGVfQ2xlYW5cIiB9KTsgfSk7XG4gICAgcm91dGVyLnVzZShcIi92MVwiLCB2MV8xLmRlZmF1bHQpO1xuICAgIHJvdXRlci51c2Uobm90Rm91bmRIYW5kbGVyXzEuZGVmYXVsdCk7XG4gICAgcm91dGVyLnVzZShlcnJvckhhbmRsZXJfMS5kZWZhdWx0KTtcbiAgICByZXR1cm4gcm91dGVyO1xufSk7XG4iXSwibWFwcGluZ3MiOiJBQUFBLFlBQVk7O0FBQ1pBLE1BQU0sQ0FBQ0MsY0FBYyxDQUFDQyxPQUFPLEVBQUUsWUFBWSxFQUFFO0VBQUVDLEtBQUssRUFBRTtBQUFLLENBQUMsQ0FBQztBQUM3RCxJQUFJQyxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxPQUFPLENBQUM7QUFDOUI7QUFDQTtBQUNBLElBQUlDLGNBQWMsR0FBR0YsT0FBTyxDQUFDRyxlQUFlLENBQUNGLE9BQU8sK0JBQTRDLENBQUM7QUFDakcsSUFBSUcsaUJBQWlCLEdBQUdKLE9BQU8sQ0FBQ0csZUFBZSxDQUFDRixPQUFPLGtDQUErQyxDQUFDO0FBQ3ZHLElBQUlJLE1BQU0sR0FBR0wsT0FBTyxDQUFDRyxlQUFlLENBQUNGLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNyRCxJQUFJSyxTQUFTLEdBQUdOLE9BQU8sQ0FBQ08sWUFBWSxDQUFDTixPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDeEQsSUFBSU8sUUFBUSxHQUFHUixPQUFPLENBQUNHLGVBQWUsQ0FBQ0YsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3pELElBQUlRLElBQUksR0FBR1QsT0FBTyxDQUFDRyxl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
