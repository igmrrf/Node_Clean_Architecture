"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true,
});
var tslib_1 = require("tslib");
// tests/db-handler.js
var mongodb_memory_server_1 = require("mongodb-memory-server");
var mongoose_1 = tslib_1.__importDefault(require("mongoose"));
/**
 * Connect to the in-memory database.
 */
// eslint-disable-next-line consistent-return
var connect = function () {
  return tslib_1.__awaiter(void 0, void 0, void 0, function () {
    var replSet, uri, mongooseOpts, error_1;
    return tslib_1.__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          return [
            4 /*yield*/,
            mongodb_memory_server_1.MongoMemoryReplSet.create({
              replSet: {
                count: 3,
              },
            }),
          ];
        case 1:
          replSet = _a.sent();
          uri = replSet.getUri();
          mongooseOpts = {
            useNewUrlParser: true,
            useUnifiedTopology: true,
          };
          _a.label = 2;
        case 2:
          _a.trys.push([2, 4, , 5]);
          return [4 /*yield*/, mongoose_1.default.connect(uri, mongooseOpts)];
        case 3:
          _a.sent();
          return [3 /*break*/, 5];
        case 4:
          error_1 = _a.sent();
          return [2 /*return*/, error_1];
        case 5:
          return [2 /*return*/];
      }
    });
  });
};
/**
 * Drop database, close the connection and stop mongod.
 */
var closeDatabase = function () {
  return tslib_1.__awaiter(void 0, void 0, void 0, function () {
    return tslib_1.__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          return [4 /*yield*/, mongoose_1.default.connection.dropDatabase()];
        case 1:
          _a.sent();
          return [4 /*yield*/, mongoose_1.default.connection.close()];
        case 2:
          _a.sent();
          return [2 /*return*/];
      }
    });
  });
};
/**
 * Remove all the data for all db collections.
 */
var clearDatabase = function () {
  return tslib_1.__awaiter(void 0, void 0, void 0, function () {
    var collections, keys, i, collection;
    return tslib_1.__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          collections = mongoose_1.default.connection.collections;
          keys = Object.keys(collections);
          i = 0;
          _a.label = 1;
        case 1:
          if (!(i < keys.length)) return [3 /*break*/, 4];
          collection = collections[keys[i]];
          // eslint-disable-next-line no-await-in-loop
          return [4 /*yield*/, collection.deleteMany()];
        case 2:
          // eslint-disable-next-line no-await-in-loop
          _a.sent();
          _a.label = 3;
        case 3:
          i += 1;
          return [3 /*break*/, 1];
        case 4:
          return [2 /*return*/];
      }
    });
  });
};

exports.default = {
  clearDatabase: clearDatabase,
  closeDatabase: closeDatabase,
  connect: connect,
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsInRzbGliXzEiLCJyZXF1aXJlIiwibW9uZ29kYl9tZW1vcnlfc2VydmVyXzEiLCJtb25nb29zZV8xIiwiX19pbXBvcnREZWZhdWx0IiwiY29ubmVjdCIsIl9fYXdhaXRlciIsInJlcGxTZXQiLCJ1cmkiLCJtb25nb29zZU9wdHMiLCJlcnJvcl8xIiwiX19nZW5lcmF0b3IiLCJfYSIsImxhYmVsIiwiTW9uZ29NZW1vcnlSZXBsU2V0IiwiY3JlYXRlIiwiY291bnQiLCJzZW50IiwiZ2V0VXJpIiwidXNlTmV3VXJsUGFyc2VyIiwidXNlVW5pZmllZFRvcG9sb2d5IiwidHJ5cyIsInB1c2giLCJkZWZhdWx0IiwiY2xvc2VEYXRhYmFzZSIsImNvbm5lY3Rpb24iLCJkcm9wRGF0YWJhc2UiLCJjbG9zZSIsImNsZWFyRGF0YWJhc2UiLCJjb2xsZWN0aW9ucyIsImtleXMiLCJpIiwiY29sbGVjdGlvbiIsImxlbmd0aCIsImRlbGV0ZU1hbnkiXSwic291cmNlcyI6WyIuLi8uLi90eXBlZC9oZWxwZXJzL3Rlc3RDb25maWcuanMiXSwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHsgdmFsdWU6IHRydWUgfSk7XG52YXIgdHNsaWJfMSA9IHJlcXVpcmUoXCJ0c2xpYlwiKTtcbi8vIHRlc3RzL2RiLWhhbmRsZXIuanNcbnZhciBtb25nb2RiX21lbW9yeV9zZXJ2ZXJfMSA9IHJlcXVpcmUoXCJtb25nb2RiLW1lbW9yeS1zZXJ2ZXJcIik7XG52YXIgbW9uZ29vc2VfMSA9IHRzbGliXzEuX19pbXBvcnREZWZhdWx0KHJlcXVpcmUoXCJtb25nb29zZVwiKSk7XG4vKipcbiAqIENvbm5lY3QgdG8gdGhlIGluLW1lbW9yeSBkYXRhYmFzZS5cbiAqL1xuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNvbnNpc3RlbnQtcmV0dXJuXG52YXIgY29ubmVjdCA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHRzbGliXzEuX19hd2FpdGVyKHZvaWQgMCwgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcmVwbFNldCwgdXJpLCBtb25nb29zZU9wdHMsIGVycm9yXzE7XG4gICAgcmV0dXJuIHRzbGliXzEuX19nZW5lcmF0b3IodGhpcywgZnVuY3Rpb24gKF9hKSB7XG4gICAgICAgIHN3aXRjaCAoX2EubGFiZWwpIHtcbiAgICAgICAgICAgIGNhc2UgMDogcmV0dXJuIFs0IC8qeWllbGQqLywgbW9uZ29kYl9tZW1vcnlfc2VydmVyXzEuTW9uZ29NZW1vcnlSZXBsU2V0LmNyZWF0ZSh7XG4gICAgICAgICAgICAgICAgICAgIHJlcGxTZXQ6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50OiAzLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIH0pXTtcbiAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgICByZXBsU2V0ID0gX2Euc2VudCgpO1xuICAgICAgICAgICAgICAgIHVyaSA9IHJlcGxTZXQuZ2V0VXJpKCk7XG4gICAgICAgICAgICAgICAgbW9uZ29vc2VPcHRzID0ge1xuICAgICAgICAgICAgICAgICAgICB1c2VOZXdVcmxQYXJzZXI6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIHVzZVVuaWZpZWRUb3BvbG9neTogdHJ1ZSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIF9hLmxhYmVsID0gMjtcbiAgICAgICAgICAgIGNhc2UgMjpcbiAgICAgICAgICAgICAgICBfYS50cnlzLnB1c2goWzIsIDQsICwgNV0pO1xuICAgICAgICAgICAgICAgIHJldHVybiBbNCAvKnlpZWxkKi8sIG1vbmdvb3NlXzEuZGVmYXVsdC5jb25uZWN0KHVyaSwgbW9uZ29vc2VPcHRzKV07XG4gICAgICAgICAgICBjYXNlIDM6XG4gICAgICAgICAgICAgICAgX2Euc2VudCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBbMyAvKmJyZWFrKi8sIDVdO1xuICAgICAgICAgICAgY2FzZSA0OlxuICAgICAgICAgICAgICAgIGVycm9yXzEgPSBfYS5zZW50KCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFsyIC8qcmV0dXJuKi8sIGVycm9yXzFdO1xuICAgICAgICAgICAgY2FzZSA1OiByZXR1cm4gWzIgLypyZXR1cm4qL107XG4gICAgICAgIH1cbiAgICB9KTtcbn0pOyB9O1xuLyoqXG4gKiBEcm9wIGRhdGFiYXNlLCBjbG9zZSB0aGUgY29ubmVjdGlvbiBhbmQgc3RvcCBtb25nb2QuXG4gKi9cbnZhciBjbG9zZURhdGFiYXNlID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gdHNsaWJfMS5fX2F3YWl0ZXIodm9pZCAwLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0c2xpYl8xLl9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYSkge1xuICAgICAgICBzd2l0Y2ggKF9hLmxhYmVsKSB7XG4gICAgICAgICAgICBjYXNlIDA6IHJldHVybiBbNCAvKnlpZWxkKi8sIG1vbmdvb3NlXzEuZGVmYXVsdC5jb25uZWN0aW9uLmRyb3BEYXRhYmFzZSgpXTtcbiAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgICBfYS5zZW50KCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFs0IC8qeWllbGQqLywgbW9uZ29vc2VfMS5kZWZhdWx0LmNvbm5lY3Rpb24uY2xvc2UoKV07XG4gICAgICAgICAgICBjYXNlIDI6XG4gICAgICAgICAgICAgICAgX2Euc2VudCgpO1xuICAgICAgICAgICAgICAgIHJldHVybiBbMiAvKnJldHVybiovXTtcbiAgICAgICAgfVxuICAgIH0pO1xufSk7IH07XG4vKipcbiAqIFJlbW92ZSBhbGwgdGhlIGRhdGEgZm9yIGFsbCBkYiBjb2xsZWN0aW9ucy5cbiAqL1xudmFyIGNsZWFyRGF0YWJhc2UgPSBmdW5jdGlvbiAoKSB7IHJldHVybiB0c2xpYl8xLl9fYXdhaXRlcih2b2lkIDAsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGNvbGxlY3Rpb25zLCBrZXlzLCBpLCBjb2xsZWN0aW9uO1xuICAgIHJldHVybiB0c2xpYl8xLl9fZ2VuZXJhdG9yKHRoaXMsIGZ1bmN0aW9uIChfYSkge1xuICAgICAgICBzd2l0Y2ggKF9hLmxhYmVsKSB7XG4gICAgICAgICAgICBjYXNlIDA6XG4gICAgICAgICAgICAgICAgY29sbGVjdGlvbnMgPSBtb25nb29zZV8xLmRlZmF1bHQuY29ubmVjdGlvbi5jb2xsZWN0aW9ucztcbiAgICAgICAgICAgICAgICBrZXlzID0gT2JqZWN0LmtleXMoY29sbGVjdGlvbnMpO1xuICAgICAgICAgICAgICAgIGkgPSAwO1xuICAgICAgICAgICAgICAgIF9hLmxhYmVsID0gMTtcbiAgICAgICAgICAgIGNhc2UgMTpcbiAgICAgICAgICAgICAgICBpZiAoIShpIDwga2V5cy5sZW5ndGgpKSByZXR1cm4gWzMgLypicmVhayovLCA0XTtcbiAgICAgICAgICAgICAgICBjb2xsZWN0aW9uID0gY29sbGVjdGlvbnNba2V5c1tpXV07XG4gICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWF3YWl0LWluLWxvb3BcbiAgICAgICAgICAgICAgICByZXR1cm4gWzQgLyp5aWVsZCovLCBjb2xsZWN0aW9uLmRlbGV0ZU1hbnkoKV07XG4gICAgICAgICAgICBjYXNlIDI6XG4gICAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWF3YWl0LWluLWxvb3BcbiAgICAgICAgICAgICAgICBfYS5zZW50KCk7XG4gICAgICAgICAgICAgICAgX2EubGFiZWwgPSAzO1xuICAgICAgICAgICAgY2FzZSAzOlxuICAgICAgICAgICAgICAgIGkgKz0gMTtcbiAgICAgICAgICAgICAgICByZXR1cm4gWzMgLypicmVhayovLCAxXTtcbiAgICAgICAgICAgIGNhc2UgNDogcmV0dXJuIFsyIC8qcmV0dXJuKi9dO1xuICAgICAgICB9XG4gICAgfSk7XG59KTsgfTtcbmV4cG9ydHMuZGVmYXVsdCA9IHsgY2xlYXJEYXRhYmFzZTogY2xlYXJEYXRhYmFzZSwgY2xvc2VEYXRhYmFzZTogY2xvc2VEYXRhYmFzZSwgY29ubmVjdDogY29ubmVjdCB9O1xuIl0sIm1hcHBpbmdzIjoiQUFBQSxZQUFZOztBQUNaQSxNQUFNLENBQUNDLGNBQWMsQ0FBQ0MsT0FBTyxFQUFFLFlBQVksRUFBRTtFQUFFQyxLQUFLLEVBQUU7QUFBSyxDQUFDLENBQUM7QUFDN0QsSUFBSUMsT0FBTyxHQUFHQyxPQUFPLENBQUMsT0FBTyxDQUFDO0FBQzlCO0FBQ0EsSUFBSUMsdUJBQXVCLEdBQUdELE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQztBQUM5RCxJQUFJRSxVQUFVLEdBQUdILE9BQU8sQ0FBQ0ksZUFBZSxDQUFDSCxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDN0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQSxJQUFJSSxPQUFPLEdBQUcsWUFBWTtFQUFFLE9BQU9MLE9BQU8sQ0FBQ00sU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssQ0FBQyxFQUFFLEtBQUssQ0FBQyxFQUFFLFlBQVk7SUFDckYsSUFBSUMsT0FBTyxFQUFFQyxHQUFHLEVBQUVDLFlBQVksRUFBRUMsT0FBTztJQUN2QyxPQUFPVixPQUFPLENBQUNXLFdBQVcsQ0FBQyxJQUFJLEVBQUUsVUFBVUMsRUFBRSxFQUFFO01BQzNDLFFBQVFBLEVBQUUsQ0FBQ0MsS0FBSztRQUNaLEtBQUssQ0FBQztVQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsV0FBV1gsdUJBQXVCLENBQUNZLGtCQUFrQixDQUFDQyxNQUFNLENBQUM7WUFDdkVSLE9BQU8sRUFBRTtjQUNMUyxLQUFLLEVBQUU7WUFDWDtVQUNKLENBQUMsQ0FBQyxDQUFDO1FBQ1AsS0FBSyxDQUFDO1VBQ0ZULE9BQU8sR0FBR0ssRUFBRSxDQUFDSyxJQUFJLEVB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
